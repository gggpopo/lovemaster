
# 恋爱大师 Agent：工具与能力调研笔记

本文档旨在为“恋爱大师 Agent”项目（技术栈：Spring AI + 火山引擎 Ark 大模型 + RAG + 记忆库）提供一份可落地的工具体系调研、选型与集成建议。

---

## 1. 截图理解与文本提取

**核心场景**：用户上传与他人的聊天截图，Agent 需要理解截图内容，为用户提供下一步的沟通建议。

- **推荐工具/方案**:
    - **首选 (P0)**: **火山方舟多模态模型 (视觉模型)**。从已读文档 `图片理解--火山方舟...-5180.txt` 和 `文档图片检索生成...-5182.txt` 来看，Ark 的多模态 API 具备直接处理图片并回答问题的能力（Visual Question Answering）。我们可以设计专门的 Prompt，让模型直接从图片中提取所需结构化信息。例如：“请分析这张聊天截图，并以 JSON 格式返回以下信息：每条消息的发送者昵称、消息文本内容、消息是发送还是接收、以及消息旁边是否有表情或贴纸。”
    - **备选 (P1)**: **火山引擎通用文字识别 (OCR) + 版面分析 (Layout)**。如果多模态模型直接提取结构化信息的效果不稳定，可降级为两步流程。首先使用通用 OCR (`文字识别-火山引擎-5181.txt`) 提取所有文字及其坐标，然后利用版面分析能力或自定义规则（如根据气泡颜色、左右位置判断发送方）来重构对话。这种方式更可控，但实现稍重。
    - **第三方 OCR**: 腾讯云、百度智能云的 OCR 服务也可作为备选，但考虑到与火山引擎生态的整合紧密度，优先使用火山自身服务。

- **集成接口建议**:
    - **火山方舟多模态模型**: 通过其 **REST API** 异步调用。将图片转为 Base64 编码后，作为请求体的一部分，通过 Spring `WebClient` 或 `RestTemplate` 发起 POST 请求。
    - **火山引擎 OCR**: 参考文档，应有独立的 **Java SDK** (`com.volcengine:volcengine-java-sdk-ark-runtime`)，封装了认证和调用逻辑，在 Spring Boot 项目中集成更方便。

- **关键风险与缓解措施**:
    - **风险**:
        - **识别准确率**: 对异形气泡、特殊字体、表情包/贴纸混排、图片压缩质量不佳等情况，识别可能出错。
        - **隐私泄露**: 聊天内容属于高度敏感信息，处理不当会引发严重隐私问题。
        - **上下文理解**: 仅靠单张截图可能无法理解完整对话背景，导致建议偏颇。
    - **缓解措施**:
        - **效果优化**: 结合 Prompt Engineering 优化多模态模型指令；对于 OCR 方案，增加后处理规则校验。
        - **隐私合规**: 在用户上传前必须有明确的授权弹窗，告知信息将被用于分析；服务端处理时，数据必须脱敏，不在日志中记录明文，处理后即时删除。
        - **产品引导**: 引导用户可上传多张连续截图，或在上传后补充必要的文字背景说明。

- **落地优先级**: **P0** (核心功能，无此能力则核心场景不成立)

---

## 2. 用户画像与个性化

**核心场景**: Agent 的建议需要符合用户的性格、沟通习惯以及与特定对象的过往互动历史。

- **推荐工具/方案**:
    - **首选 (P0)**: **火山 Ark 记忆库 (AgentKit / VikingDB)**。根据 `记忆库概述--AgentKit-火山引擎-5158.txt` 和 `向量数据库VikingDB-火山引擎-2105.txt`，火山提供了记忆库解决方案。这套方案能结构化地存储和检索会话历史、用户偏好等信息。我们可以为每个用户建立独立的记忆库实例或分区。
    - **自建方案 (P1)**: 如果需要更高度的定制化，可以基于 **Spring AI 的 `ChatMemory`** 接口，结合 Redis 或关系型数据库自建记忆存储。但这需要自行设计数据模型和遗忘曲线等逻辑，复杂度较高。

- **集成接口建议**:
    - **火山 Ark 记忆库**: 预计提供 **REST API** 或 **Java SDK**。在每次与用户交互后，调用其 `add/update` 接口，将新的交互信息（如用户本次采纳的建议、对话反馈、新提取的偏好）更新到记忆库。在生成建议前，调用其 `search/retrieve` 接口，获取与当前场景相关的用户画像和历史记忆。

- **关键风险与缓解措施**:
    - **风险**:
        - **数据治理与隐私**: 用户画像数据比单次聊天更敏感，需严格遵守数据保护法规（如《个人信息保护法》）。
        - **画像准确性**: 自动提取的画像可能不准或过时，影响建议质量。
        - **冷启动问题**: 新用户没有历史数据，导致初期建议泛化。
    - **缓解措施**:
        - **隐私策略**: 设计清晰的数据授权与退出机制，允许用户查看、编辑和删除自己的画像数据。所有存储数据必须加密和脱敏。
        - **画像校准**: 定期或在关键节点（如用户给出差评后）引导用户主动校准或补充自己的偏好标签。
        - **冷启动策略**: 对于新用户，提供几种典型的“沟通风格”供其选择，作为初始画像。

- **落地优先级**: **P0** (核心竞争力，个性化是 Agent 是否“好用”的关键)

---

## 3. RAG 能力

**核心场景**: 为 Agent 提供高质量、可随时更新的“恋爱话术”、“沟通技巧”知识库。

- **推荐工具/方案**:
    - **首选 (P0)**: **火山知识库 (基于 VikingDB)**。`文档图片检索生成--火山方舟...-5182.txt` 中提到，火山知识库支持文档、图片的混合检索。这非常适合构建包含案例、理论、甚至表情包解读的恋爱知识库。平台提供从文本分块、Embedding 到检索的全托管服务。
    - **Spring AI `VectorStore` 适配 (P0)**: 无论底层用什么，上层应用代码都应通过 Spring AI 的 `VectorStore` 接口进行交互。我们可以编写一个 `VolcanoKnowledgeBaseVectorStore` 实现类，封装对火山知识库 REST API 的调用。这样既能利用火山的托管能力，又保持了应用层代码的框架标准和可移植性。

- **集成接口建议**:
    - **火山知识库**: 提供 **REST API**，包括 `upsert_data` 和 `search_knowledge` 等。通过封装成 Spring AI 的 `VectorStore` 后，上层业务代码只需调用标准的 `add` 和 `similaritySearch` 方法。
    - **Embedding 模型**: 使用火山方舟提供的 Embedding 模型，并通过 Spring AI 的 `EmbeddingClient` 接口调用。

- **关键风险与缓解措施**:
    - **风险**:
        - **检索质量**: 召回的话术与当前场景不匹配，导致建议牛头不对马嘴。
        - **分块策略**: 文档分块（Chunking）不合理，破坏了知识的完整性。
        - **知识更新**: 知识库内容陈旧，跟不上网络热点和语言习惯的变化。
    - **缓解措施**:
        - **混合检索与 Rerank**: 如果火山知识库支持，开启“向量+关键词”混合检索。在检索后，可以增加一个 Reranker 模型对召回结果重排序，提升匹配度。
        - **优化分块**: 采用语义分块或基于标题结构的分块策略，保证知识单元的完整。
        - **建立更新机制**: 定期从高质量来源（如社交媒体、情感类文章、心理学研究）补充和更新知识库内容。

- **落地优先级**: **P0** (RAG 是 Agent 提供高质量、非泛泛而谈建议的基础)

---

## 4. 工具调用 (Function Calling / Tool Calling)

**核心场景**: 让 Agent 具备多样的辅助能力，而不仅仅是文本生成。基于 `函数调用_API_Spring_AI_参考_-_Spring-5167.txt` 文档，Spring AI 提供了标准的 Function Calling 实现。

- **4.1. 表情包推荐工具**
    - **推荐方案**: 自建表情包/Sticker 数据库，通过向量检索实现。将表情包打上标签（如“开心”、“尴尬”、“抱歉”），并对标签进行 Embedding。
    - **集成接口**: 定义一个 Java Function `recommendStickers(String mood, String context)`，在内部实现向量检索逻辑，返回图片 URL 列表。
    - **风险**: 推荐不精准；版权问题。
    - **缓解**: 优化标签体系；使用无版权或已获授权的表情包。
    - **优先级**: **P1**

- **4.2. 语气/情感分析工具**
    - **推荐方案**: **火山引擎自然语言处理-情感分析**。用于分析用户输入文本和待生成回复的情感倾向。
    - **集成接口**: 定义 `analyzeSentiment(String text)` 函数，内部调用火山 NLP REST API。
    - **风险**: 情感识别不准，尤其对于反讽等复杂情况。
    - **缓解**: 结合上下文进行综合判断，或将模型判断作为参考而非决策。
    - **优先级**: **P1**

- **4.3. 文风风格化工具**
    - **推荐方案**: 基于 **火山 Ark 大模型** 的 Prompt Engineering。这不是一个外部工具，而是通过精心设计的 `System Prompt` 实现。
    - **集成接口**: 在调用 ChatClient 时，动态构建 `SystemMessage`，例如 `new SystemMessage("请你扮演一位幽默风趣的聊天搭子，使用轻松、搞笑的语气改写以下回复：...")`。
    - **风险**: 风格转换生硬或不稳定。
    - **缓解**: 准备多个高质量的风格化 Prompt 模板。
    - **优先级**: **P0**

- **4.4. 内容风险检测工具**
    - **推荐方案**: **火山引擎内容安全服务**。对用户输入和 Agent 生成的回复进行检测。
    - **集成接口**: 定义 `detectContentRisk(String text)` 函数，内部调用火山内容安全 REST API。
    - **风险**: 误判和漏判。
    - **缓解**: 设置合理的风险阈值，对于高风险内容坚决阻断，中低风险可提示用户。
    - **优先级**: **P0** (安全合规底线)

- **4.5. 话术 A/B 测试工具**
    - **推荐方案**: 在应用层实现。Agent 生成两个版本的建议（A/B），并记录用户最终选择了哪个。
    - **集成接口**: 在返回建议时，为每个建议附加一个唯一的 `traceId`。用户点击后，客户端上报 `(traceId, choice: 'A' or 'B')`。
    - **风险**: 数据量不足时，统计意义不大。
    - **缓解**: 长期、大规模收集数据，并结合其他指标（如下文转化率）综合分析。
    - **优先级**: **P2** (优化工具，初期可无)

- **4.6. 图片生成/编辑工具**
    - **推荐方案**: **火山引擎 Seedream 模型**。根据 `Seedream_4.5_SDK_示例官方教程...-5189.txt`，可以通过 API 生成图片。
    - **集成接口**: 定义 `generateImage(String prompt)` 函数，调用 Seedream API 生成符合语境的图片（如一张简单的“晚安”贺卡）。
    - **风险**: 生成图片质量不稳定，或与需求不符；成本较高。
    - **缓解**: 优化 Prompt；限制使用频率或仅对付费用户开放。
    - **优先级**: **P2**

- **4.7. TTS/语音风格工具**
    - **推荐方案**: **火山引擎语音合成 (TTS)**。参考 `使用TTS(语音合成)...-5203.txt` 和第三方 `volcengine-tts-spring-boot-st.-5200.txt`，可以方便地将文本转为语音。
    - **集成接口**: 定义 `textToSpeech(String text, String voiceStyle)` 函数，返回音频文件 URL。
    - **风险**: 语音情感不够自然。
    - **缓解**: 选择支持情感和风格调节的高级音色。
    - **优先级**: **P2**

- **4.8. 调度类工具**
    - **推荐方案**: 调用 **外部 API**（如高德地图、大众点评）或操作 **系统日历**。
    - **集成接口**: 定义 `searchNearbyRestaurants(String location)`、`createCalendarEvent(String title, String time)` 等函数，内部通过 `WebClient` 调用第三方 API。
    - **风险**: 依赖外部服务稳定性；需要用户授权。
    - **缓解**: 做好错误处理和重试；在调用前明确请求用户授权。
    - **优先级**: **P1**

---

## 5. 端到端治理

**核心场景**: 保障 Agent 服务的稳定性、可控性和持续迭代能力。

- **推荐方案/关注点**:
    - **监控指标 (P0)**: 重点监控 API 调用成功率、响应延迟（P95/P99）、Token 消耗量、RAG 检索命中率。
    - **灰度发布 (P1)**: 新功能、新 Prompt、新模型上线时，采用灰度策略，小流量验证效果，避免对全量用户造成负面影响。
    - **闭环学习 (P1)**: 建立用户反馈机制（点赞/点踩、评论），并与 A/B 测试数据结合，定期分析 bad case，用于优化 Prompt 和 RAG 知识库。
    - **提示词治理 (P0)**: 将所有 Prompt 作为配置进行管理，而不是硬编码在代码中。建立 Prompt 版本控制和评测流程。
    - **评测集 (P1)**: 构建一套覆盖核心场景（如初次搭讪、关系升温、矛盾化解）的评测数据集，用于评估模型和策略迭代的效果。

- **集成建议**:
    - **监控**: 使用 Micrometer + Prometheus/Grafana 体系。
    - **灰度**: 依赖公司的流量分发平台或自建流量切分逻辑。
    - **反馈/学习**: 结合数据上报和离线分析平台。

- **关键风险与缓解措施**:
    - **风险**: 治理体系建设复杂，投入人力大。
    - **缓解**: 从最核心的监控和提示词管理做起，逐步完善其他环节。

- **落地优先级**: **P0/P1** (决定了项目能否从“玩具”走向“产品”)
